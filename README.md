# AIBCC: Персонализация умных пушей (Кейс 1)

Этот репозиторий строит умную push-автоматизацию для банка: мы анализируем 3 месяца поведения, считаем ожидаемую выгоду клиента по каждому продукту, выбираем лучший продукт и генерируем персональные, соответствующие бренду push-тексты.

# Финальный CSV: Итоговое решение можно найти в [submissions/pushes_final.csv](https://github.com/samsondawit/aibcc-case-1-decentrathon/blob/main/submissions/pushes_final.csv).

## Конвейер

- Канонизация и признаки
  - Входы: `case_1/clients.csv`, `case_1/client_-_transactions_3m.csv`, `case_1/client_-_transfers_3m.csv`
  - Выходы:
    - `data/canonicalized/client_{i}_transactions_3m_canon.csv`
    - `data/features_per_client.csv`

- Выгоды и Топ-4 (с взаимным исключением + отладкой)
  - Считает приращение выгод продукта (отн. дебетового базиса), потолки и коэффициенты реализации (adoption).
  - Добавляет взаимное исключение: когда явно доминирует поведение по вкладам, допустимые траты под кредит сокращаются.
  - Выходы:
    - `data/benefits_per_client.csv`
    - `data/top4_per_client.csv`
    - `data/benefits_debug_per_client.csv` (почему выбранное: реализации, потолки, допустимые траты до/после MX)

- Движок LLM-копирайта (Gemini 2.5 Flash)
  - Строит структурированный контекст на клиента и вызывает Gemini с ретраями, JSON со строго заданной схемой, санацией и автоисправлением (CTA / "вы" / длина 180–220).
  - Выходы:
    - `data/personalized_pushes.csv`
    - `data/llm_copy_debug.jsonl` (каждая попытка: ошибки, санитайзер, причины валидатора)

- Экспорт
  - Присоединяется к первым трём сценариям, применяет политику отправки/не-отправки, валидирует и выдает итоговый CSV из 3 столбцов.
  - Выходы:
    - `data/submissions/pushes_final.csv` (точно: `client_code,product,push_notification`)
    - `data/submissions/pushes_with_debug.csv` (более подробный объяснитель)

## Быстрый старт

### 0) Зависимости Python

```bash
pip install -r requirements.txt
```

### 1) Окружение

Создайте .env в корне репозитория:

```bash
GOOGLE_API_KEY=AIza...your_key...
```

### 2) Запуск всего

Однострочник Bash:

```bash
bash run_all.sh
```

### 3) Проверка результатов

- Submission: data/submissions/pushes_final.csv
- Debug: data/submissions/pushes_with_debug.csv
- LLM debug: data/llm_copy_debug.jsonl
- Benefits debug: data/benefits_debug_per_client.csv

## Как build_features.py принимает решения

- Кредитная карта: 10% на (Top-3 ∪ Online) сверх базового 1%, с месячным потолком и реализацией из data-driven скоринга пригодности.
- Премиальная карта: база 2–4% (по балансу) + 4% на буст-категории, минус базис, плюс экономия на банкоматах/переводах, умноженное на коэффициент реализации.
- Путешествия: 4% минус базис на travel/taxi-траты, умноженное на реализацию по активности такси/отелей.
- Вклады: выбираем тип (Накопительный/Сберегательный/Мульти) по поведению, затем умножаем на реализацию.
- FX: %-экономия на FX-объеме, с большей реализацией при существенном FX-объеме.
- Взаимное исключение: когда поведение по вкладам доминирует (высокий баланс, низкие траты или выгода по вкладу близка к кредиту), уменьшаем допустимые траты под кредит (диверсия 10–60%).
- Разрешение ничьей: стабильный порядок, если выгоды равны в пределах эпсилон.

## Безопасность и качество LLM

- Структурированный JSON с enum CTA: модель должна вернуть {"message": "...", "cta": "<one-of>"}.
- Строгий санитайзер обрабатывает кодовые блоки, массивы, лишний текст.
- Валидатор проверяет: длина 180–220, ровно один CTA (белый список), "вы/вас", <= 1 эмодзи, <= 1 "!".
- Автоисправление: если коротко — вставить одно фактическое предложение перед CTA; нормализовать спряжение CTA; обеспечить "вы"; ужать, если длинно.
- Ретраи: экспоненциальный backoff; при ошибках JSON/схемы/валидации возвращаем модели точные ошибки.

## Параметры конфигурации

Редактируйте в build_benefits.py, generate_pushes.py:

build_benefits.py:

```bash
BASELINE_CB, CREDIT_CAP_MONTHLY, TRAVEL_REALIZATION_BASE, PREMIUM_REALIZATION_-, и т.д.
Пороги взаимного исключения в benefits_for_client_row().
```

generate_pushes.py:

```bash
MIN_LEN, MAX_LEN, ALLOWED_CTA
LLM_MAX_RETRIES, TOKEN_BUDGET
Правила тона: REQUIRE_VY_LOWER, лимиты на эмодзи/восклицания
```

### Результаты

data/submissions/pushes_final.csv - финальный CSV из 3 столбцов
data/submissions/pushes_with_debug.csv - объяснимый аудит-трейл


